# -*- coding: utf-8 -*-
"""formulario.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ZTUaUBborPNJ90qX9pQc8Dg1axVt_rgA
"""

import streamlit as st
from streamlit_js_eval import streamlit_js_eval
from datetime import datetime
from zoneinfo import ZoneInfo

# =========================
# CONFIG
# =========================
st.set_page_config(page_title="Checklist", layout="centered")

st.title("Checklist de Auditoria")

# =========================
# CAMPOS INICIAIS
# =========================

regional = st.selectbox("Regional", ["Selecione", "Sul", "Sudeste"])
coordenador = st.selectbox("Coordenador", ["Selecione", "João", "Maria"])
loja = st.selectbox("Loja", ["Selecione", "Loja 1", "Loja 2"])
supervisor = st.text_input("Supervisor")

# =========================
# GEOLOCALIZAÇÃO
# =========================

st.divider()
st.subheader("Validação de Localização")

if "localizacao" not in st.session_state:
    st.session_state.localizacao = None

if st.button("Capturar Localização"):
    st.session_state.localizacao = streamlit_js_eval(
        js_expressions="""
        new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(
                (pos) => resolve({
                    latitude: pos.coords.latitude,
                    longitude: pos.coords.longitude,
                    accuracy: pos.coords.accuracy
                }),
                (err) => resolve(null)
            );
        })
        """,
        key="get_location"
    )

if st.session_state.localizacao:
    st.success("Localização capturada com sucesso ✅")
    st.write(st.session_state.localizacao)  # pode remover depois

# =========================
# FORMULÁRIO
# =========================

perguntas = [
    "A fachada está limpa?",
    "O estoque está organizado?",
    "A equipe está uniformizada?"
]

with st.form("checklist_form"):

    st.subheader("Perguntas")

    respostas = []

    for i, pergunta in enumerate(perguntas, start=1):
        resposta = st.radio(
            pergunta,
            ["Sim", "Não"],
            horizontal=True,
            key=f"q{i}"
        )
        respostas.append(resposta)

    st.divider()

    enviar = st.form_submit_button("Enviar Checklist")

# =========================
# ENVIO
# =========================

if enviar:

    # Validação campos obrigatórios
    if (
        regional == "Selecione" or
        coordenador == "Selecione" or
        loja == "Selecione" or
        not supervisor.strip()
    ):
        st.error("Preencha todos os campos obrigatórios antes de enviar.")
        st.stop()

    # Validação geolocalização
    if not st.session_state.localizacao:
        st.error("Clique primeiro em 'Capturar Localização' antes de enviar.")
        st.stop()

    latitude = st.session_state.localizacao["latitude"]
    longitude = st.session_state.localizacao["longitude"]
    precisao = st.session_state.localizacao["accuracy"]

    agora = datetime.now(
        ZoneInfo("America/Sao_Paulo")
    ).strftime("%Y-%m-%d %H:%M:%S")

    # =========================
    # AQUI VOCÊ ENVIA PARA A PLANILHA
    # =========================

    linha = [
        agora,
        regional,
        coordenador,
        loja,
        supervisor,
        latitude,
        longitude,
        precisao,
        *respostas
    ]

    # sheet.append_row(linha)
    print(linha)  # substitua pela sua função real

    st.success("Checklist enviado com sucesso ✅")

    # Limpa localização após envio
    st.session_state.localizacao = None

