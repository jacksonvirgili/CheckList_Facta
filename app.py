# -*- coding: utf-8 -*-
"""formulario.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ZTUaUBborPNJ90qX9pQc8Dg1axVt_rgA
"""

# -*- coding: utf-8 -*-
import time
from io import BytesIO
from datetime import datetime
from zoneinfo import ZoneInfo

import streamlit as st
import gspread
from gspread.exceptions import APIError, WorksheetNotFound
from streamlit_js_eval import streamlit_js_eval
from google.oauth2.service_account import Credentials

# ReportLab - PDF
from reportlab.lib.pagesizes import A4
from reportlab.lib.units import mm
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib import colors

# =====================
# CONFIGURA√á√ïES
# =====================

SHEET_ID = "11JaCc4y-htBW-cxbvbMBV28GHYlORbMM6345TSaXcgQ"
NOME_ABA = "Respostas"

scope = [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/drive",
]

# =====================
# GOOGLE SHEETS (credenciais)
# =====================

# Certifique-se de ter configurado st.secrets["gcp_service_account"] corretamente
service_account_info = dict(st.secrets["gcp_service_account"])

credentials = Credentials.from_service_account_info(
    service_account_info,
    scopes=scope
)
gc = gspread.authorize(credentials)

# =====================
# FUN√á√ïES AUXILIARES (Sheets)
# =====================

def get_worksheet(gc_client, sheet_id: str, tab_name: str):
    """
    Abre a planilha e retorna a worksheet (aba) desejada.
    Exibe mensagens amig√°veis em caso de falha.
    """
    try:
        sh = gc_client.open_by_key(sheet_id)
    except APIError as e:
        code = getattr(getattr(e, "response", None), "status_code", None)
        detail = ""
        try:
            detail = e.response.json()
        except Exception:
            body = getattr(getattr(e, "response", None), "text", "")[:400]
            detail = f"status={code} body={body}"
        st.error(
            "‚ùå Erro ao abrir a planilha no Google Sheets.\n\n"
            "‚Ä¢ Verifique se a Service Account tem acesso (Compartilhar como Editor)\n"
            "‚Ä¢ Confirme se o SHEET_ID est√° correto\n"
            "‚Ä¢ Garanta que as APIs Google Sheets e Google Drive est√£o habilitadas no projeto da credencial\n\n"
            f"Detalhes t√©cnicos: {detail}"
        )
        st.stop()

    try:
        ws = sh.worksheet(tab_name)
    except WorksheetNotFound:
        st.error(f"‚ùå A aba '{tab_name}' n√£o existe na planilha. Crie essa aba ou ajuste NOME_ABA.")
        st.stop()

    return ws


def append_with_retry(ws, row, retries: int = 4):
    """
    Faz append_row com tentativas (retry) e backoff exponencial
    em caso de erros transit√≥rios como 429/500/503.
    """
    for i in range(retries):
        try:
            ws.append_row(row)
            return True
        except APIError as e:
            code = getattr(getattr(e, "response", None), "status_code", None)
            if code in (429, 500, 503) and i < retries - 1:
                time.sleep((2 ** i) + 0.2)
                continue
            raise

# =====================
# FUN√á√ÉO PARA GERAR PDF
# =====================

def gerar_pdf_checklist(
    agora, regional, coordenador, loja, supervisor,
    latitude, longitude, precisao,
    perguntas, respostas
):
    """
    Gera um PDF em mem√≥ria com:
    - Identifica√ß√£o
    - Resumo geral (% de 'Sim')
    - Link do mapa (se houver localiza√ß√£o)
    - Tabela de perguntas/respostas
    Retorna um BytesIO pronto para download.
    """
    buffer = BytesIO()

    doc = SimpleDocTemplate(
        buffer,
        pagesize=A4,
        leftMargin=20*mm,
        rightMargin=20*mm,
        topMargin=15*mm,
        bottomMargin=15*mm
    )

    styles = getSampleStyleSheet()
    styles.add(ParagraphStyle(name="Titulo", fontName="Helvetica-Bold", fontSize=16, leading=18, spaceAfter=8))
    styles.add(ParagraphStyle(name="SubTitulo", fontName="Helvetica-Bold", fontSize=12, leading=14, spaceBefore=10, spaceAfter=4))
    styles.add(ParagraphStyle(name="Normal10", fontName="Helvetica", fontSize=10, leading=12))

    elementos = []

    # Cabe√ßalho e Identifica√ß√£o
    elementos.append(Paragraph("Check-list de Acompanhamento", styles["Titulo"]))
    elementos.append(Paragraph("Identifica√ß√£o", styles["SubTitulo"]))

    meta_data = [
        ["Data/Hora", agora],
        ["Regional", regional],
        ["Coordenador", coordenador],
        ["Loja", loja],
        ["Supervisor", supervisor],
        ["Latitude", f"{latitude:.6f}" if isinstance(latitude, (int, float)) else (str(latitude) if latitude is not None else "-")],
        ["Longitude", f"{longitude:.6f}" if isinstance(longitude, (int, float)) else (str(longitude) if longitude is not None else "-")],
        ["Precis√£o (m)", f"{precisao:.0f}" if isinstance(precisao, (int, float)) else (str(precisao) if precisao is not None else "-")],
    ]
    tabela_meta = Table(meta_data, colWidths=[40*mm, None], hAlign="LEFT")
    tabela_meta.setStyle(TableStyle([
        ("FONTNAME", (0,0), (-1,-1), "Helvetica"),
        ("FONTSIZE", (0,0), (-1,-1), 10),
        ("ALIGN", (0,0), (-1,-1), "LEFT"),
        ("VALIGN", (0,0), (-1,-1), "MIDDLE"),
        ("BACKGROUND", (0,0), (0,-1), colors.whitesmoke),
        ("INNERGRID", (0,0), (-1,-1), 0.25, colors.grey),
        ("BOX", (0,0), (-1,-1), 0.5, colors.grey),
        ("LEFTPADDING", (0,0), (-1,-1), 4),
        ("RIGHTPADDING", (0,0), (-1,-1), 4),
        ("TOPPADDING", (0,0), (-1,-1), 3),
        ("BOTTOMPADDING", (0,0), (-1,-1), 3),
    ]))
    elementos.append(tabela_meta)
    elementos.append(Spacer(1, 6))

    # Resumo geral
    total_perguntas = len(perguntas)
    total_sim = sum(1 for r in respostas if r == "Sim")
    perc = (total_sim / total_perguntas) * 100 if total_perguntas else 0.0
    elementos.append(Paragraph("Resumo", styles["SubTitulo"]))
    elementos.append(Paragraph(f"Respostas 'Sim': {total_sim}/{total_perguntas} ({perc:.1f}%)", styles["Normal10"]))
    elementos.append(Spacer(1, 4))

    # Link do mapa
    if (latitude is not None) and (longitude is not None):
        url_map = f"https://www.google.com/maps?q={latitude},{longitude}"
        elementos.append(Paragraph(f"Localiza√ß√£o: {url_map}", styles["Normal10"]))
        elementos.append(Spacer(1, 6))

    # Perguntas e respostas
    elementos.append(Paragraph("Perguntas e Respostas", styles["SubTitulo"]))
    linhas = [["#", "Pergunta", "Resposta"]]
    for idx, (p, r) in enumerate(zip(perguntas, respostas), start=1):
        linhas.append([f"{idx:02d}", p, r])

    tabela_qa = Table(linhas, colWidths=[12*mm, None, 25*mm], repeatRows=1)
    tabela_qa.setStyle(TableStyle([
        ("FONTNAME", (0,0), (-1,0), "Helvetica-Bold"),
        ("FONTSIZE", (0,0), (-1,0), 10),
        ("BACKGROUND", (0,0), (-1,0), colors.lightgrey),
        ("TEXTCOLOR", (0,0), (-1,0), colors.black),

        ("FONTNAME", (0,1), (-1,-1), "Helvetica"),
        ("FONTSIZE", (0,1), (-1,-1), 9),
        ("VALIGN", (0,0), (-1,-1), "TOP"),

        ("ROWBACKGROUNDS", (0,1), (-1,-1), [colors.whitesmoke, colors.white]),
        ("INNERGRID", (0,0), (-1,-1), 0.25, colors.grey),
        ("BOX", (0,0), (-1,-1), 0.5, colors.grey),

        ("LEFTPADDING", (0,0), (-1,-1), 4),
        ("RIGHTPADDING", (0,0), (-1,-1), 4),
        ("TOPPADDING", (0,0), (-1,-1), 3),
        ("BOTTOMPADDING", (0,0), (-1,-1), 3),
    ]))
    elementos.append(tabela_qa)
    elementos.append(Spacer(1, 8))

    # Rodap√©
    elementos.append(Paragraph("Documento gerado automaticamente pelo Check-list de Acompanhamento.", styles["Normal10"]))

    doc.build(elementos)
    buffer.seek(0)
    return buffer

# =====================
# INTERFACE
# =====================

st.title("Check-list de Acompanhamento")
st.subheader("Identifica√ß√£o")

# Placeholder para mostrar mensagem de sucesso + download juntos (fora do form)
feedback_slot = st.empty()

hierarquia = {
    # ... (SEU DICION√ÅRIO COMPLETO DE HIERARQUIA AQUI, SEM ALTERA√á√ïES) ...
    "ADRIELE DA SILVA SOUZA": {
        "ANA PICOLLI": ['2222 - LOJA BALNEARIO CAMBORIU - SC',
                        '2913 - LOJA CHAPECO - SC',
                        '2802 - LOJA FLORIANOPOLIS - SC',
                        '200022 - LOJA ITAJAI - SC',
                        '20959 - LOJA JOINVILLE - SC',
                        '2918 - LOJA PALHO√áA - SC',
                        '2945 - LOJA SAO JOSE - SC'],
        # (demais coordenadores e regionais id√™nticos ao seu c√≥digo)
    },
    # ... (restante do dicion√°rio exatamente como voc√™ j√° tinha) ...
}

# ===== SELECTS FORA DO FORM =====
regional = st.selectbox(
    "Regional",
    options=["Selecione"] + list(hierarquia.keys())
)

coordenador = "Selecione"
loja = "Selecione"

if regional != "Selecione":
    coordenador = st.selectbox(
        "Coordenador",
        options=["Selecione"] + list(hierarquia[regional].keys())
    )

if coordenador != "Selecione":
    loja = st.selectbox(
        "Loja",
        options=["Selecione"] + hierarquia[regional][coordenador]
    )

supervisor = st.text_input("Supervisor de Loja")

st.divider()

# =====================
# VALIDA√á√ÉO DE LOCALIZA√á√ÉO
# =====================
# Key est√°vel para n√£o reexecutar a cada rerun sem necessidade
localizacao = streamlit_js_eval(
    js_expressions="""
    new Promise((resolve) => {
        if (!('geolocation' in navigator)) {
            resolve(null);
            return;
        }
        navigator.geolocation.getCurrentPosition(
            (pos) => resolve({
                latitude: pos.coords.latitude,
                longitude: pos.coords.longitude,
                accuracy: pos.coords.accuracy
            }),
            (err) => resolve({ error: err.code || true, message: err.message || 'erro' }),
            {
                enableHighAccuracy: true,
                timeout: 12000,
                maximumAge: 0
            }
        );
    })
    """,
    key="get_location_once"
)

# (Atendendo seu pedido: REMOVIDO o bot√£o "üîÑ Capturar localiza√ß√£o agora")

# Mostra aviso se o navegador retornou erro
if isinstance(localizacao, dict) and localizacao.get("error"):
    st.warning(
        "N√£o foi poss√≠vel obter a geolocaliza√ß√£o agora. "
        "Tente novamente (melhor sinal de GPS/Wi‚ÄëFi) ou recarregue a p√°gina.\n\n"
        f"Detalhe t√©cnico: {localizacao.get('message', 'sem detalhes')}"
    )

# =====================
# FORMUL√ÅRIO
# =====================
st.subheader("Perguntas")

perguntas = [
    "01. Analisa os indicadores quantitativos diariamente D-1 e INTRADAY e Registra e compartilha os resultados com o consultor?",
    "02. Aplica o CLAV semanalmente com base em evid√™ncias",
    "03. Aplica e mantem atualizado o diagn√≥stico do colaborador, usando as informa√ß√µes de maneira estrat√©gica",
    "04. Realiza microtreinamentos com a equipe",
    "05. Est√° presente corrigindo execu√ß√µes em tempo real",
    "06. Utiliza o Teatro de Vendas e Aplica din√¢micas r√°pidas e criativas durante o dia",
    "07. Aplica Feedback SAR com frequ√™ncia",
    "08. Supervisor consegue ser claro quanto as evid√™ncias de aplica√ß√£o que ser√£o verificadas nos pr√≥ximos atendimentos/dias.",
    "09. A equipe domina t√©cnica de pesquisa (perguntas abertas e SPIN)",
    "10. A equipe sabe destacar vantagens e benef√≠cios dos produtos comercializados",
    "11. A equipe sabe destacar as vantagens e benef√≠cios da empresa para o cliente",
    "12. A equipe em loja possui total dom√≠nio nas t√©cnicas de neutraliza√ß√£o de obje√ß√µes e as utilizam quando necess√°ria nos atendimentos",
    "13. A equipe em loja tem habilidade necess√°ria para realizar o cross de todos os produtos para cada cliente.",
    "14. Os Consultores pedem indica√ß√£o ao final do atendimento",
    "15. Os Consultores seguem os passos da jornada",
    "16. Reconhece avan√ßos da equipe",
    "17. Utiliza linguagem positiva e motivadora",
    "18. Supervisor conhece sonhos e objetivos de cada colaborador",
    "19. Acompanha indicadores t√©cnicos semanalmente (ATIVA)",
    "20. Analisa comportamento da equipe com base em dados (CLAV e Observa√ß√£o Direta)",
    "21. Garante que o que foi treinado esteja sendo aplicado atrav√©s da observa√ß√£o de evid√™ncias de aplica√ß√£o.",
    "22. Faz reuni√µes 1:1 com os consultores semanalmente",
    "23. Atualiza e utiliza o PDI individual customizando as a√ß√µes de treinamento em loja",
    "24. Supervisor tem ci√™ncia de todas as pend√™ncias de contrato, e propostas negadas",
    "25. Consultores sabem sua meta di√°ria, acumulado, tkm, etc e sabem a import√¢ncia destes n√∫meros",
    "26. O Supervisor de Loja possui de forma clara e objetiva o controle da informa√ß√£o de agendamentos",
    "27. A equipe na loja conhece e domina todos os campos e funcionalidades de todos os sistemas operacionais?",
    "28. A equipe da loja possui boa apresenta√ß√£o pessoal, de acordo com as pol√≠ticas e normas de conduta da empresa",
    "29. O Supervisor de Loja organiza e acompanha diariamente o rod√≠zio de acionamentos de sua equipe?",
    "30. O Supervisor de Loja tem acompanhado os comunicados internos, lendo entendendo, repassando e orientando sua equipe, garantindo entendimento e a execu√ß√£o imediata?",
    "31. O Supervisor acompanha e trata o n√£o pagamento da 1¬™ parcela d√©bito.",
    "32. O Supervisor atua diariamente sobre os saldos de portabilidade - aprovando, cancelando e analisando os motivos dos saldos cancelados.",
    "33. O Supervisor de Loja conhece a particularidade de sua carteira de clientes de FF, como potencial, popula√ß√£o da cidade e carteira de cliente ativos e inativos por produto?",
    "34. Supervisor faz a gest√£o e controle das horas extras diariamente?",
    "35. A equipe mant√©m assiduidade em loja (pontualidade e frequ√™ncia).",
    "36. Supervisor faz a gest√£o e controle das horas extras diariamente?",
    "37. Todos os chamados necess√°rios para reparo, manuten√ß√£o, infraestrutura, etc... est√£o abertos e aguardando solu√ß√£o."
]

with st.form("checklist_form"):

    respostas = []

    for i, pergunta in enumerate(perguntas, start=1):

        # T√≠tulos de se√ß√£o (apenas visual)
        if i == 1:
            st.subheader("AVALIAR")
        elif i == 4:
            st.subheader("TREINAR")
        elif i == 9:
            st.subheader("DOM√çNIO DE METODO POR PARTE DA EQUIPE")
        elif i == 16:
            st.subheader("INCENTIVAR")
        elif i == 19:
            st.subheader("VERIFICAR")
        elif i == 22:
            st.subheader("ACOMPANHAR")
        elif i == 26:
            st.subheader("ACOMPANHAMENTO - OPERA√á√ÉO")
        elif i == 37:
            st.subheader("ACOMPANHAMENTO - ESTRUTURA")

        resposta = st.radio(
            pergunta,
            ["Sim", "N√£o"],
            horizontal=True,
            key=f"q{i}"
        )
        respostas.append(resposta)

    st.divider()

    confirmar_localizacao = st.checkbox(
        "Autorizo a captura da minha localiza√ß√£o para envio do checklist"
    )

    enviar = st.form_submit_button("Enviar Checklist")

    # =====================
    # SALVAR NO GOOGLE SHEETS + GERAR PDF
    # =====================
    if enviar:

        # üîí Valida checkbox
        if not confirmar_localizacao:
            st.error("Voc√™ precisa autorizar a captura da localiza√ß√£o para enviar.")
            st.stop()

        # üîí Valida captura real da localiza√ß√£o
        if not localizacao or (isinstance(localizacao, dict) and localizacao.get("error")):
            st.error("N√£o foi poss√≠vel capturar sua localiza√ß√£o. Verifique as permiss√µes do navegador e tente novamente.")
            st.stop()

        latitude = localizacao["latitude"]
        longitude = localizacao["longitude"]
        precisao = localizacao["accuracy"]

        if (
            regional == "Selecione"
            or coordenador == "Selecione"
            or loja == "Selecione"
            or not supervisor.strip()
        ):
            st.error("Preencha todos os campos obrigat√≥rios antes de enviar.")
            st.stop()

        agora = datetime.now(ZoneInfo("America/Sao_Paulo")).strftime("%Y-%m-%d %H:%M:%S")

        linha = [
            agora,
            regional,
            coordenador,
            loja,
            supervisor,
            latitude,
            longitude,
            precisao,
            *respostas
        ]

        # üîê Abre a planilha/aba s√≥ no envio (evita estourar cota de leitura)
        ws = get_worksheet(gc, SHEET_ID, NOME_ABA)
        append_with_retry(ws, linha)

        # ‚úÖ Gera o PDF com try/except (se falhar, mostra o erro)
        pdf_bytes = None
        try:
            pdf_buffer = gerar_pdf_checklist(
                agora=agora,
                regional=regional,
                coordenador=coordenador,
                loja=loja,
                supervisor=supervisor,
                latitude=latitude,
                longitude=longitude,
                precisao=precisao,
                perguntas=perguntas,
                respostas=respostas
            )
            pdf_bytes = pdf_buffer.getvalue()
        except Exception as e:
            st.error("‚ö†Ô∏è Ocorreu um erro ao gerar o PDF.")
            st.exception(e)

        if pdf_bytes:
            st.session_state["pdf_bytes"] = pdf_bytes
            st.session_state["pdf_name"] = f"checklist_{agora.replace(':','-').replace(' ', '_')}.pdf"
            st.session_state["just_submitted"] = True
        else:
            st.session_state["pdf_bytes"] = None
            st.session_state["pdf_name"] = None
            st.session_state["just_submitted"] = False

# =====================
# FEEDBACK (SUCESSO + DOWNLOAD) FORA DO FORM
# =====================
if st.session_state.get("pdf_bytes") and st.session_state.get("just_submitted"):
    with feedback_slot.container():
        st.success("Checklist enviado com sucesso ‚úÖ")
        st.download_button(
            label="üìÑ Baixar PDF do checklist",
            data=st.session_state["pdf_bytes"],
            file_name=st.session_state.get("pdf_name", "checklist.pdf"),
            mime="application/pdf",
            key="download_pdf_together"
        )
    # Evita ficar repetindo a mensagem ao interagir nos widgets depois
    st.session_state["just_submitted"] = False
elif st.session_state.get("pdf_bytes"):
    # Caso o usu√°rio j√° tenha enviado antes, pode manter o bot√£o dispon√≠vel
    with feedback_slot.container():
        st.download_button(
            label="üìÑ Baixar PDF do checklist (√∫ltimo envio)",
            data=st.session_state["pdf_bytes"],
            file_name=st.session_state.get("pdf_name", "checklist.pdf"),
            mime="application/pdf",
            key="download_pdf_last"
        )
else:
    feedback_slot.empty()
